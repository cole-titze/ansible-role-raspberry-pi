---
- name: Gather OS distribution info
  ansible.builtin.setup:
    filter: ansible_distribution
    gather_subset: min

- name: Configure static IP for non-Arch systems
  block:
    - name: Check if using dhcpcd for networking.
      ansible.builtin.stat:
        path: /etc/dhcpcd.conf
      register: dhcpcd_file_result

    - name: Configure static IP address (dhcpcd).
      ansible.builtin.blockinfile:
        path: /etc/dhcpcd.conf
        marker: "# ANSIBLE MANAGED - static ip {mark}"
        block: |
          interface eth0
          static ip_address={{ ipv4_subnet_prefix }}.{{ ip_host_octet }}/24
          static routers={{ ipv4_subnet_prefix }}.1
          static domain_name_servers={{ ipv4_subnet_prefix }}.1
      notify: restart dhcpcd
      when: dhcpcd_file_result.stat.exists

    - name: Configure static IP address (Network Manager).
      community.general.nmcli:
        conn_name: "Wired connection 1"
        ifname: eth0
        type: ethernet
        ip4: "{{ ipv4_subnet_prefix }}.{{ ip_host_octet }}/24"
        gw4: "{{ ipv4_gateway }}"
        dns4: "{{ dns4_servers }}"
        state: present
      notify: restart networkmanager
      when: not dhcpcd_file_result.stat.exists
  when: ansible_distribution != "Archlinux"

- name: Configure static IP for Arch (PiKVM-style)
  block:

    - name: Define desired eth0.network content
      set_fact:
        eth0_network_desired: |
          [Match]
          Name=eth0

          [Network]
          Address={{ ipv4_subnet_prefix }}.{{ ip_host_octet }}/24
          Gateway={{ ipv4_gateway }}
          DNS={{ dns4_servers }}
          DNS={{ dns4_servers }}

    - name: Define desired wlan0.network content
      set_fact:
        wlan0_network_desired: |
          [Match]
          Name=wlan0

          [Network]
          Address={{ ipv4_subnet_prefix }}.{{ ip_host_octet }}/24
          Gateway={{ ipv4_gateway }}
          DNS={{ dns4_servers }}
          DNS={{ dns4_servers }}

    - name: Read current eth0.network file if it exists
      ansible.builtin.slurp:
        path: /etc/systemd/network/eth0.network
      register: eth0_network_current
      ignore_errors: yes

    - name: Read current wlan0.network file if it exists
      ansible.builtin.slurp:
        path: /etc/systemd/network/wlan0.network
      register: wlan0_network_current
      ignore_errors: yes

    - name: Decode eth0.network or use empty string
      set_fact:
        eth0_network_current_decoded: "{{ eth0_network_current.content | default('') | b64decode | string }}"

    - name: Decode wlan0.network or use empty string
      set_fact:
        wlan0_network_current_decoded: "{{ wlan0_network_current.content | default('') | b64decode | string }}"

    - name: Determine if eth0.network needs update
      set_fact:
        eth0_network_needs_update: "{{ eth0_network_desired.strip() != eth0_network_current_decoded.strip() }}"

    - name: Determine if wlan0.network needs update
      set_fact:
        wlan0_network_needs_update: "{{ wlan0_network_desired.strip() != wlan0_network_current_decoded.strip() }}"

    - name: Remount root filesystem as read-write if needed
      ansible.builtin.command: rw
      become: true
      when: eth0_network_needs_update or wlan0_network_needs_update

    - name: Update eth0.network if needed
      copy:
        dest: /etc/systemd/network/eth0.network
        owner: root
        group: root
        mode: '0644'
        content: "{{ eth0_network_desired }}"
      when: eth0_network_needs_update
      register: eth0_network_changed

    - name: Update wlan0.network if needed
      copy:
        dest: /etc/systemd/network/wlan0.network
        owner: root
        group: root
        mode: '0644'
        content: "{{ wlan0_network_desired }}"
      when: wlan0_network_needs_update
      register: wlan0_network_changed

    - name: Remount root filesystem as read-only if changed
      ansible.builtin.command: mount -o remount,ro /
      become: true
      when: eth0_network_needs_update or wlan0_network_needs_update

    - name: Reboot Pi to apply static IP changes
      reboot:
        msg: "Rebooting to apply static IP configuration"
        connect_timeout: 5
        reboot_timeout: 300
      when: eth0_network_needs_update or wlan0_network_needs_update

  when: ansible_distribution == "Archlinux"